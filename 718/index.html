<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ˆæé±¿é±¼æ‘‡å·æœº</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');

        :root {
            --bg-color: #1a1a1a;
            --car-color: #2c2c2c;
            --seat-color: #444;
            --seat-highlight-color: #ffde00;
            --text-color: #f0f0f0;
            --primary-color: #e50914; /* é±¿é±¼æ¸¸æˆä¸»é¢˜çº¢ */
            --accent-color: #00d1b2; /* é±¿é±¼æ¸¸æˆä¸»é¢˜ç»¿ */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
            animation: glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary-color), 0 0 20px var(--primary-color);
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #ff4da6, 0 0 30px #ff4da6, 0 0 40px #ff4da6;
            }
        }

        p.subtitle {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 30px;
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .controls label {
            font-size: 1rem;
        }

        #driver-select, #start-button {
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: 700;
        }

        #driver-select {
            background-color: var(--seat-color);
            color: var(--text-color);
            border: 2px solid var(--accent-color);
        }

        #start-button {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
        }

        #start-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(229, 9, 20, 0.6);
        }

        #start-button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }

        .car-layout {
            background-color: var(--car-color);
            border-radius: 30px 30px 20px 20px;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(3, 1fr);
            gap: 25px 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid #333;
        }

        .car-layout::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -20px;
            width: 15px;
            height: 40px;
            background: #222;
            border-radius: 10px 0 0 10px;
            border: 2px solid #333;
            border-right: none;
        }

        .car-layout::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -20px;
            width: 15px;
            height: 40px;
            background: #222;
            border-radius: 0 10px 10px 0;
            border: 2px solid #333;
            border-left: none;
        }


        .seat {
            background-color: var(--seat-color);
            border-radius: 12px;
            min-height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            border: 3px solid transparent;
        }

        .name-placeholder {
            transition: opacity 0.2s ease-in-out;
        }

        /* åº§ä½å¸ƒå±€ */
        .seat[data-seat-id="1"] { grid-column: 1 / 2; grid-row: 1 / 2; } /* å¸æœº */
        .seat[data-seat-id="2"] { grid-column: 2 / 3; grid-row: 1 / 2; } /* å‰¯é©¾ */
        .seat[data-seat-id="3"] { grid-column: 1 / 2; grid-row: 2 / 3; }
        .seat[data-seat-id="4"] { grid-column: 2 / 3; grid-row: 2 / 3; }
        .seat[data-seat-id="5"] { grid-column: 1 / 3; grid-row: 3 / 4; } /* åæ’ä¸­é—´éœ€è¦ç‰¹æ®Šå¤„ç† */

        /* åæ’ä¸‰åº§æ ·å¼ */
        .back-row-container {
            grid-column: 1 / 3;
            grid-row: 3 / 4;
            display: flex;
            gap: 15px;
        }
        .back-row-container .seat {
            flex: 1;
        }

        /* å¸æœºä½ç‰¹æ®Šæ ·å¼ */
        .driver-seat {
            border-color: var(--accent-color);
        }
        .driver-seat::after {
            content: 'ğŸš—'; /* æˆ– 'â˜¸' */
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 1.5rem;
            opacity: 0.5;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .seat.highlight {
            transform: scale(1.1);
            border-color: var(--seat-highlight-color);
            background-color: #5a5a5a;
            box-shadow: 0 0 20px var(--seat-highlight-color);
        }

        .seat.finalized {
            animation: finalized-pop 0.5s ease-out forwards;
        }

        @keyframes finalized-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background-color: var(--accent-color); color: #1a1a1a; }
            100% { transform: scale(1.1); background-color: var(--accent-color); color: #1a1a1a; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ç»ˆæé±¿é±¼æ‘‡å·æœº</h1>
    <p class="subtitle">æ¯æ¬¡ä¸Šè½¦éƒ½æ˜¯ä¸€åœºæƒŠå¿ƒåŠ¨é­„çš„å†’é™©ï¼</p>

    <div class="controls">
        <label for="driver-select">æœ¬è½®å¸æœº:</label>
        <select id="driver-select">
            <option value="random">ğŸ² éšæœºé€‰ä¸€åå¹¸è¿å¸æœº</option>
        </select>
        <button id="start-button">å¼€å§‹æ‘‡å·</button>
    </div>

    <div class="car-layout">
        <!-- å‰æ’ -->
        <div class="seat driver-seat" data-seat-id="1"><div class="name-placeholder">å¸æœº</div></div>
        <div class="seat" data-seat-id="2"><div class="name-placeholder">å‰¯é©¾</div></div>
        <!-- ä¸­æ’ -->
        <div class="seat" data-seat-id="3"><div class="name-placeholder"></div></div>
        <div class="seat" data-seat-id="4"><div class="name-placeholder"></div></div>
        <!-- åæ’ (ç”¨ä¸€ä¸ªå®¹å™¨åŒ…èµ·æ¥å®ç°ä¸‰åº§) -->
        <div class="back-row-container">
            <div class="seat" data-seat-id="5"><div class="name-placeholder"></div></div>
            <div class="seat" data-seat-id="6"><div class="name-placeholder"></div></div>
            <div class="seat" data-seat-id="7"><div class="name-placeholder"></div></div>
        </div>
    </div>
</div>

<audio id="bgm" src="bgm.mp3" preload="auto"></audio>

<script>
    // --- é…ç½®åŒº ---
    const config = {
        people: {
            drivers: ['æ¯›å„¿', 'äº”å°‘', 'ğŸŒŸ'],
            passengers: ['Ren', 'å°ç‹', 'ç¿åª›', 'å¤©å¤©']
        },
        animation: {
            spinInterval: 180, // éŸ³ä¹è½¬ç›˜èŠ‚å¥ï¼Œå•ä½ms
            scrambleDuration: 3000, // æœ€ç»ˆæ´—ç‰Œæ—¶é•¿ï¼Œå•ä½ms
            scrambleInterval: 75, // æ´—ç‰Œåˆ·æ–°ç‡ï¼Œå•ä½ms
            revealDelay: 300, // æœ€ç»ˆç»“æœæ­æ™“å»¶è¿Ÿï¼Œå•ä½ms
            musicDuration: 18000 // éŸ³ä¹æ’­æ”¾æ—¶é•¿ï¼Œå•ä½ms
        }
    };

    // --- DOMå…ƒç´ è·å– ---
    const driverSelect = document.getElementById('driver-select');
    const startButton = document.getElementById('start-button');
    const seats = Array.from(document.querySelectorAll('.seat'));
    const namePlaceholders = Array.from(document.querySelectorAll('.name-placeholder'));
    const bgm = document.getElementById('bgm');

    // --- å…¨å±€å˜é‡ ---
    let isSpinning = false;
    let spinIntervalId = null;
    let scrambleIntervalId = null;
    const allPeople = [...config.people.drivers, ...config.people.passengers];

    // --- åˆå§‹åŒ– ---
    function initialize() {
        // å¡«å……å¸æœºä¸‹æ‹‰é€‰é¡¹
        config.people.drivers.forEach(driver => {
            const option = document.createElement('option');
            option.value = driver;
            option.textContent = `æŒ‡å®šå¸æœº: ${driver}`;
            driverSelect.appendChild(option);
        });

        // è®¾ç½®åº§ä½åˆå§‹æ–‡æœ¬
        const defaultTexts = ['å¸æœº', 'å‰¯é©¾', 'å·¦ä¸­', 'å³ä¸­', 'å·¦å', 'ä¸­å', 'å³å'];
        namePlaceholders.forEach((p, i) => {
            p.textContent = defaultTexts[i] || 'åº§ä½';
        });

        // ç»‘å®šäº‹ä»¶
        startButton.addEventListener('click', startLottery);
    }

    // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

    // æ´—ç‰Œç®—æ³• (Fisher-Yates)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // é‡ç½®UIçŠ¶æ€
    function resetUI() {
        seats.forEach(seat => {
            seat.classList.remove('highlight', 'finalized');
            seat.style.backgroundColor = '';
            seat.style.color = '';
        });
        const defaultTexts = ['å¸æœº', 'å‰¯é©¾', 'å·¦ä¸­', 'å³ä¸­', 'å·¦å', 'ä¸­å', 'å³å'];
        namePlaceholders.forEach((p, i) => {
            p.textContent = defaultTexts[i] || 'åº§ä½';
            p.style.opacity = 1;
        });
    }

    // å¼€å§‹æ‘‡å·
    function startLottery() {
        if (isSpinning) return;
        isSpinning = true;
        startButton.disabled = true;
        startButton.textContent = 'æ‘‡å·ä¸­...';

        resetUI();

        // æ’­æ”¾éŸ³ä¹
        bgm.currentTime = 0;
        bgm.play().catch(e => console.error("éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));

        // 1. ç¡®å®šæœ¬è½®äººå‘˜åˆ†é…æ–¹æ¡ˆ
        let driver;
        let others;
        const selectedDriverValue = driverSelect.value;

        if (selectedDriverValue === 'random') {
            const shuffledDrivers = shuffleArray([...config.people.drivers]);
            driver = shuffledDrivers.shift();
            others = shuffleArray([...shuffledDrivers, ...config.people.passengers]);
        } else {
            driver = selectedDriverValue;
            others = shuffleArray(allPeople.filter(p => p !== driver));
        }

        const finalAssignments = [driver, ...others];

        // 2. å¼€å§‹éŸ³ä¹è½¬ç›˜åŠ¨ç”»
        const seatOrder = [1, 2, 4, 7, 6, 5, 3]; // å®šä¹‰è½¬åœˆé¡ºåº
        let spinIndex = 0;
        spinIntervalId = setInterval(() => {
            seats.forEach(s => s.classList.remove('highlight'));
            const currentSeatId = seatOrder[spinIndex % seatOrder.length];
            const currentSeat = document.querySelector(`.seat[data-seat-id="${currentSeatId}"]`);
            currentSeat.classList.add('highlight');
            spinIndex++;
        }, config.animation.spinInterval);

        // 3. éŸ³ä¹è½¬ç›˜åŠ¨ç”»ç»“æŸåï¼Œå¼€å§‹å¿«é€Ÿæ´—ç‰ŒåŠ¨ç”»
        setTimeout(() => {
            clearInterval(spinIntervalId);
            seats.forEach(s => s.classList.remove('highlight'));

            // å¼€å§‹æ´—ç‰ŒåŠ¨ç”»
            scrambleIntervalId = setInterval(() => {
                const shuffledPeople = shuffleArray([...allPeople]);
                namePlaceholders.forEach((p, i) => {
                    p.textContent = shuffledPeople[i];
                });
            }, config.animation.scrambleInterval);

            // 4. åœæ­¢æ´—ç‰Œï¼Œæ­æ™“æœ€ç»ˆç»“æœ
            setTimeout(() => {
                clearInterval(scrambleIntervalId);
                bgm.pause();
                revealResults(finalAssignments);
            }, config.animation.scrambleDuration);

        }, config.animation.musicDuration);
    }

    // æ­æ™“æœ€ç»ˆç»“æœ
    function revealResults(assignments) {
        startButton.textContent = 'å°˜åŸƒè½å®šï¼';
        assignments.forEach((person, index) => {
            const seatIndex = index; // 0-6
            const seatElement = seats[seatIndex];
            const placeholder = namePlaceholders[seatIndex];

            setTimeout(() => {
                placeholder.textContent = person;
                seatElement.classList.add('finalized');
            }, index * config.animation.revealDelay);
        });

        // æ‘‡å·ç»“æŸï¼Œæ¢å¤æŒ‰é’®
        setTimeout(() => {
            isSpinning = false;
            startButton.disabled = false;
            startButton.textContent = 'å†æ¥ä¸€è½®ï¼';
        }, assignments.length * config.animation.revealDelay + 500);
    }


    // --- é¡µé¢åŠ è½½åæ‰§è¡Œåˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
